---
title: "CAPITAL MARKETS - FINAL PROJECT"
author: "Miguel Angel Malagon - Manuel Camilo Corredor"
date: '2022-05-21'
output: html_document
---

```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r,echo=FALSE,warning=FALSE, cache=FALSE, message=FALSE}
#install.packages("quantmod")
library(quantmod)
library(readxl)
library(dygraphs)
library(PerformanceAnalytics) #for sharpe
library(datasets)
library(tidyverse) #for sort
library(ggplot2)
library(ggthemes)
library(readxl)
#install.packages("kableExtra")
#library(kableExtra)
```

# 1. Measuring fund performance

Inicialmente seleccionamos 20  fondos mutuos de capital o ETF con sede en los Estados Unidos entre mayo de 2017 y abril de 2022.

```{r}
library(readxl)
nombre_fondos <- read_excel("Fondos.xlsx")
nombre_fondos

```


```{r}
tickers <- c("VSMPX","VFIAX","DODGX","SWPPX","RLBGX","FSGEX","VGHAX",
             "FPCIX","FTBFX","BBCPX","PTTRX","FKINX","CAIBX","ABALX",
             "AGTHX","GFFFX","AMECX","TRBCX","PIMIX","FBKWX")


```

Calcule los rendimientos anuales promedio de cada fondo y determine qué fondos están en el top 5 de rendimiento. Presente algunas estadísticas de los fondos. 

**¿Cuáles son las limitaciones/problemas de clasificar el rendimiento utilizando rendimientos sin procesar?**


```{r,echo=FALSE}
Prices <- c()
for (activos in tickers){
  Prices <- cbind(Prices,getSymbols.yahoo(
    Symbols =activos,index.class  = 'Date',from ="2017-05-01",
    to="2022-03-02",periodicity = "monthly",auto.assign = FALSE)[,6])
}
colnames(Prices)<-tickers

```


Una vez tenemos nuestros precios vamos a calcular las rentabilidades de cada uno de los fondos, para conocer posteriormente cual es el fondo con mayores rentabilidades.


```{r}
Rentabilidad <- c()
n <- ncol(Prices)
for (i in 1:n){

    Rentabilidad <- cbind(Rentabilidad,monthlyReturn(Prices[,i],leading = FALSE))[-1,]
}
colnames(Rentabilidad)<-tickers  
media<-data.frame(sort(round(colMeans(Rentabilidad),4),decreasing = TRUE))
colnames(media)<-"Media"
head(media,5)

```

```{r}
nombre_fondos[c(16,4,15,18,1,2,3,7),]

```


**¿Cuáles son las limitaciones/problemas de clasificar el rendimiento utilizando rendimientos sin procesar?**

- Calcular la media de las rentabilidades de manera aritmética puede estar un sesgada, pues en la muestra puede haber datos que jalen la muestra ya sea hacía arriba (Datos muy altos) o hacía abajo (Datos muy bajos), dificultando tomar una decisión de manera más objetiva a partir de las rentabilidades. En los apartados siguientes mostraremos otras maneras de analizar las rentabilidades.

**Sharpe Ratio:**

- Calcule el Sharpe Ratio (SR) de cada fondo. 

$$
\frac{(R_{a}-R_{f})}{σ}
$$

- Clasificar los fondos por (SR). ¿Cuáles son los 5 primeros? ¿Son estos los mismos que la pregunta anterior? Explicar


```{r}
sharpe_ratio <- round(
  SharpeRatio(Rentabilidad, Rf = 0.0016761), 4
)

Filtro <- cbind(sort(sharpe_ratio[1,1:20]))
print(Filtro[16:20,1])
#Filtro <- as.matrix(sort(Filtro,decreasing = TRUE))
#head(Filtro)
```

Una vez tenemos el sharpe Ratio calculado, realizamos la comparación con la tabal de medias y notamos que en esta oportunidad el top 5 se invierte y aparece un nuevo fondo  ** VSMPX**

**¿Cuáles son las limitaciones de usar SR para clasificar el rendimiento de los fondos?**

- Claramente el SR esta teniendo encuenta la tasa libre de riesgo y la deviación estandar, es por eso que hay variación en los resultados. Pero así como esto nos acerca a conocer un poco más cual puede llegar a tener un portafolio optimo, pero puede tener otra implicación grande y es que el Sharpe Ratio, puede tener estar sobre estimando el Risk Free Asset.

## Fama-French 3F model 

Utilice los 3 factores de Fama-French para estimar la siguiente ecuación para cada fondo: 

$$
R_{it}=\alpha_i+\beta \ast RMRF_t +b_i \ast SMB_t +h_i \ast HML_t + \epsilon_{it}
$$


```{r}
# FAMA & FRENCH
Data_Factors <- read_excel("Data_Factors.xlsx")
names(Data_Factors)[2] <-"RMRF"
```


```{r}
#CALCULAMOS LAS VARIABLES Y (Rentabilidad_activo - RF)
variable_y <- c()
x <- ncol(Rentabilidad)
for (i in 1:x) {
  variable_y<- cbind(variable_y,((Rentabilidad[,i])-(Data_Factors$RF)))
}
```



```{r}
X1 <- Data_Factors[,2:4]
X <- as.matrix( cbind(1,X1))
Y <- as.matrix(variable_y[,1])
beta <- solve(t(X)%*%X)%*%t(X)%*%Y
beta

```

$$
\hat{\beta}=(X^TX)^{-1}X^TY
$$

```{r}
betas <- cbind()
Intercepto <- cbind()
RMRF <- cbind()
SMB <- cbind()
HML <- cbind()
for (i in 1:20){
  betas <- solve(t(X)%*%X)%*%t(X)%*%variable_y[,i]
  Intercepto[i] <- betas[1,1]
  RMRF[i]<- betas[2,1]
  SMB[i] <- betas[3,1]
  HML[i] <- betas[4,1]
}
```

```{r}
todo <- cbind(Intercepto,RMRF,SMB,HML)
# Transpone todas las columnas menos la primer
df_transpose <- data.frame(t(todo))
# Añadimos los nombres de las columnas
colnames(df_transpose)<-tickers
```

```{r}
Filtro1 <- cbind(sort(df_transpose[1,1:20]))
Filtro2 <- t(Filtro1)
print(Filtro2[16:20,1])
```


# 2. Time varying beta

```{r}
Betas <- read_excel("Betas.xlsx")
```

```{r}
Rm <-Betas$`Adj Close**`
Raapl <- Betas$`Adj Close`
Var1 <- c()
Var2 <- c()
n <- length(Rm)
for(i in 1:n){
Var1[i] <- (Rm[i+1]/Rm[i])-1
Var2[i] <- (Raapl[i+1]-Raapl[i])/Raapl[i]

}
Var1 <- c(NA,Var1)
Var1 <-Var1[-269]
Var2<- c(NA,Var2)
Var2 <-Var2[-269]

Data_Betas <- as.data.frame(cbind(Raapl,Var2,Rm,Var1)[-1,])
#Data_Betas <- cbind(Data_Betas)
```

```{r}

cov <- cov(Data_Betas$Var2,Data_Betas$Var1)
var <- var(Data_Betas$Var1)

beta <- cov/var
t <- dim(Data_Betas)[1]
ventana <- cbind()
cov1 <- cbind()
var1 <- cbind()


for(i in 1:(n-60)){
  cov1[i] <- cov(Data_Betas$Var2[i:(59+i)],Data_Betas$Var1[i:(59+i)])
  var1[i] <- var(Data_Betas$Var1[i:(59+i)])
  ventana <- cov1/var1
}
y <- 1:208
ventana1 <- as.data.frame(cbind(ventana,y)) 

```



```{r}
ggplot(ventana1) +
geom_line(aes(y=ventana,x=y), colour= "blue",size=1) +
ggtitle("                     Serie de Beta Ventana 60 meses") +
labs(x="Periodo de Tiempo",y="Beta" )+
theme_economist()+theme(axis.text = element_text(angle=0))
  
  

```


# 3. Performance of Colombian Pension Funds.


Descargue una serie mensual de 10 años de rendimientos para cada una de las cuatro compañías administradoras de fondos de pensiones obligatorias en Colombia (use el "Portafolio Moderado"). 

```{r}
Fondos <- read_excel("retornos_fondos.xlsx")
head(Fondos)
```


```{r}
RG <- Fondos$`MSCI -DTF`
RL <- Fondos$`COLCAP - DTF`
Xfondos <- cbind(1,RG,RL)
PROTECCION <- cbind(Fondos$PROTECCION)
PORVENIR<- cbind(Fondos$PORVENIR)
SKANDIA<- cbind(Fondos$SKANDIA)
COLFONDOS<- cbind(Fondos$COLFONDOS)

```

## Estimación de CAPM Mix

Vamos a estimar un CAPM 'mixto' donde la cartera de mercado incluye tanto los rendimientos de un índice de renta variable internacional (los rendimientos de una cartera de renta variable global en COP sobre el activo libre de riesgo, RG) como el rendimiento del mercado de renta variable nacional (rendimiento del COLCAP sobre el activo libre de riesgo, RL). Para cada fondo de pensiones, hay que estimar la siguiente ecuación:

Para la estimación del CAPM mixto, vamos a utilizar los rendimientos de el MSCI index Global, el cual esta compuesto por las empresas más rentables en los diferentes países desarrollados.

![MSCI INDEX](C:/Users/migue/Documents/GitHub/final-project/index.png)

Por otro lado, utilizamos el DTF como la tasa libre de riesgo y el COLCAP como el índice de capital nacional.

- **VARIABLES**:

  -*RG:* MSCI - DF
  
  -*RL:* COLCAP -DF

Para cada fondo de pensiones, se realizaron las estimaciones conforme a la siguiente ecuación:

$$
R_{it}=\alpha_i+\beta_i\bullet{RG}_t+\gamma_i\bullet{RL}_t+\varepsilon_{it}
$$
Explicar cuál es el papel de los coeficientes, y qué nos dicen los valores estimados sobre cada fondo de pensiones y su perfil de riesgo. ¿Son muy diferentes los coeficientes estimados? Explicar.

- **Fondo Proteccion:**

```{r}
lm(PROTECCION~RG+RL)
```
Para el fondo de proteccion podemos notar que el coeficiente que más afecta el modelo es el RG, es decir el indice global, en comparación con el coeficiente asociado a la varaible RL (cOLCAP).

- **Fondo Porvenir:**

```{r}
lm(PORVENIR~RG+RL)
```
Por otro lado, el portafolio moderado de pensiones de poervenir muestra un mayor coeficiente en la variable RG.

- **Fondo Skandia:**

```{r}
lm(SKANDIA~RG+RL)
```
Así mismo para el caso del fondo Skandia el factor internacional representado en el MSCI index Global, tiene un mayor impacto a comparación con el Colcap.  


- **Fondo Colfondos:**

```{r}
lm(COLFONDOS~RG+RL)
```
Finalmente para el caso del fondo COLFONDOS, este tambien tiene un coeficiente alto para la variable RG, en comparación con el RL


```{r}
Beta_PROTECCION <- solve(t(Xfondos)%*%Xfondos)%*%t(Xfondos)%*%PROTECCION
Beta_PORVENIR <- solve(t(Xfondos)%*%Xfondos)%*%t(Xfondos)%*%PORVENIR
Beta_SKANDIA <- solve(t(Xfondos)%*%Xfondos)%*%t(Xfondos)%*%SKANDIA
Beta_COLFONDOS <- solve(t(Xfondos)%*%Xfondos)%*%t(Xfondos)%*%COLFONDOS
#Beta_PROTECCION
#Beta_PORVENIR 
#Beta_SKANDIA
#Beta_COLFONDOS
```

##Macro-factor model:


```{r}
library(readxl)
macro_factors <- read_excel("macro_factors.xlsx")
```

```{r}
TRM <- cbind(macro_factors$TRM)
TES <- cbind(macro_factors$TES)
IPC <- cbind(macro_factors$IPC)
```

Para poder continuar con nuestro análisis que nos permita explicar de dónde provienen los rendimientos de los fondos de pensiones colombianos, ahora a nuestro modelo empleado anteriormente, vamos agregarle 3 factores más, pero en este caso serán factores macroeconómicos tales como la tasa de referencia del mercado (TRM), la tasa de los TES a 1 año y finalmente el IPC, pues consideramos que estas variables pueden darnos más indicios para llegar a una conclusión final acerca de las rentabilidades de los fondos de inversión, para eso utilizaremos la siguiente ecuación.

$$
R_{it}=\alpha_i+\beta_i\bullet{RG}_t+\gamma_i\bullet{RL}_t+b_1F_1+b_2F_2+b_3F_3+\varepsilon_{it}
$$

Para iniciar corremos la regresión para los diferentes fondos de pensiones y posteriormente realizamos un análisis sobre las variables de cada uno. 


- **Fondo Proteccion:**

```{r}
lm(PROTECCION~RG+RL+TRM+TES+IPC)
```

Para el fondo protección podemos notar que hay un cambio en los coeficientes con respecto a la anterior regresión del mismo fondo podemos notar que el intercepto es casi cero por lo que las rentabilidades dadas por el fondo son acertadas, Por otro lado el coeficiente que más significancia tienen el modelo es del factor internacional, pues es de 0.4298, Así mismo el factor macroeconómico de test tiene también una alta significancia en el modelo 0.1283 y finalmente variables como la TRM y el IPC Son coeficientes que afectan al modelo de forma negativa.


- **Fondo Porvenir:**

```{r}
lm(PORVENIR~RG+RL+TRM+TES+IPC)
```

Continuando con el análisis y teniendo factores macroeconómicos podemos ver que en el caso de porvenir los coeficientes del IPC e internacionales como el MSCI index Global, son altos por lo que podemos concluir que las rentabilidades de las pensiones obligatorias del fondo porvenir están más ligadas a las expectativas de inflación que presenta el país, como también a un factor internacional, sin embargo el coeficiente de los TEST es casi cero por lo que podríamos afirmar que no tiene una relación con los títulos de renta fija nacionales, sin embargo no significa que su portafolio no tenga está clase de títulos pues podrían ser internacionales.

- **Fondo Skandia:**

```{r}
lm(SKANDIA~RG+RL+TRM+TES+IPC)
```

Por otro lado el fondo de pensiones skandia a diferencia del fondo porvenir los coeficientes de IPC como el de la TRM son negativos, En este caso el intercepto es negativo por lo que podríamos inferir que las rentabilidades generadas estarían por debajo de las esperadas por parte de los inversionistas, en la misma línea de análisis los dos factores con mayor significancia son los del mercado de renta variable internacional y los de TES colombianos. 


- **Fondo Colfondos:**

```{r}
lm(COLFONDOS~RG+RL+TRM+TES+IPC)
```

Finalmente haciendo un análisis al fondo de pensiones Colfondos, podemos notar que la variable internacional y los TEST colombianos tienen el mayor coeficiente, esto nos podría dar indicios que las rentabilidades de dicho fondo están más sujetas a los mercados internacionales que locales debido a que el factor RL (COLCAP) es significativamente pequeño, también podemos destacar que los factores como la TRM y IPC son significativamente negativos.

